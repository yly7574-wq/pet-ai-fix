<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å® ç‰©çš®è‚¤ç—… AI å…è´¹åˆç­›</title>
    <!-- å¼•å…¥ Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #FF9EAA;
            --secondary-color: #FFF5E1;
            --text-color: #4A4A4A;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FAFAFA;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            color: #FF6B81;
            margin-bottom: 10px;
        }

        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--primary-color);
            border-radius: 16px;
            background-color: var(--secondary-color);
            height: 200px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .upload-area:active { transform: scale(0.99); }

        .file-input-hidden {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0; 
            cursor: pointer;
            z-index: 20; 
        }

        .upload-content {
            text-align: center;
            pointer-events: none;
        }

        .upload-icon { font-size: 3rem; margin-bottom: 10px; }
        .upload-text { color: #888; font-size: 0.9rem; }

        #previewImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 14px;
            pointer-events: none;
        }

        .btn-diagnose {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 158, 170, 0.4);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-diagnose:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

        #statusLog {
            font-size: 0.85rem;
            color: #666;
            background: #F2F3F5;
            padding: 12px;
            border-radius: 8px;
            display: none;
            white-space: pre-wrap;
        }

        #resultArea {
            background-color: #F8F9FA;
            border-radius: 12px;
            padding: 16px;
            display: none;
            line-height: 1.6;
        }
        #resultContent img { max-width: 100%; border-radius: 8px; }

        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #fff;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; margin-right: 10px; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ±ğŸ¶ å® ç‰©çš®è‚¤ç—…<br>AI å…è´¹åˆç­›</h1>

    <label class="upload-area" id="dropZone">
        <input type="file" id="fileInput" accept="image/*" class="file-input-hidden">
        <div class="upload-content" id="uploadPlaceholder">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ç‚¹å‡»è¿™é‡Œä¸Šä¼ ç…§ç‰‡</div>
        </div>
        <img id="previewImage" alt="Preview">
    </label>

    <button class="btn-diagnose" id="diagnoseBtn">
        <div class="loading-spinner" id="spinner"></div>
        <span id="btnText">å¼€å§‹è¯Šæ–­</span>
    </button>
    
    <div id="statusLog"></div>

    <div id="resultArea">
        <div id="resultContent"></div>
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ (Pages Functions ç‰ˆ) =================
    
    // 1. è¿™é‡Œä¿æŒä¸ºç©ºå­—ç¬¦ä¸² '' å³å¯ï¼
    // è¿™æ ·ä»£ç ä¼šè‡ªåŠ¨è¯·æ±‚å½“å‰åŸŸåä¸‹çš„ /upload, /chat æ¥å£
    // Cloudflare Pages ä¼šè‡ªåŠ¨æŠŠè¿™äº›è¯·æ±‚è·¯ç”±ç»™ä½ çš„ functions/[[path]].js
    const WORKER_URL = ''; 

    // 2. å¡«å…¥ä½ çš„ Bot ID
    const COZE_BOT_ID = '7584683174408880138';          

    // =============================================================

    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const diagnoseBtn = document.getElementById('diagnoseBtn');
    const resultArea = document.getElementById('resultArea');
    const resultContent = document.getElementById('resultContent');
    const statusLog = document.getElementById('statusLog');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btnText');

    let selectedFile = null;

    function log(msg, isError = false) {
        statusLog.style.display = 'block';
        statusLog.innerText = msg;
        statusLog.style.color = isError ? '#FF4D4F' : '#666';
        if(isError) console.error(msg); else console.log(msg);
    }

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            if (!file.type.startsWith('image/')) return alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (evt) => {
                previewImage.src = evt.target.result;
                previewImage.style.display = 'block';
                log(`ğŸ“¸ å·²é€‰å›¾ç‰‡: ${file.name}`);
            };
            reader.readAsDataURL(file);
        }
    });

    diagnoseBtn.addEventListener('click', async () => {
        // æœ¬åœ°ç¯å¢ƒæ£€æŸ¥
        if (window.location.protocol === 'file:') {
            return alert('âŒ è¯·å°†é¡¹ç›®éƒ¨ç½²åˆ° Cloudflare Pages åå†è¿è¡Œï¼\næœ¬åœ°ç›´æ¥æ‰“å¼€æ— æ³•è°ƒç”¨ Functions æ¥å£ã€‚');
        }

        if (!selectedFile) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
        
        setLoading(true);
        resultArea.style.display = 'none';
        
        try {
            // 1. ä¸Šä¼ å›¾ç‰‡ (è¯·æ±‚ç›¸å¯¹è·¯å¾„ /upload)
            log('ğŸš€ 1/3 æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');
            const fileId = await uploadFileToProxy(selectedFile);
            
            // 2. åˆ›å»ºå¯¹è¯å¹¶è½®è¯¢ (è¯·æ±‚ç›¸å¯¹è·¯å¾„ /chat)
            log('ğŸ¤– 2/3 å›¾ç‰‡å·²æ¥æ”¶ï¼ŒAIæ­£åœ¨æ€è€ƒä¸­...');
            const answer = await processChatProxy(fileId);
            
            // 3. æ¸²æŸ“
            log('âœ¨ 3/3 è¯Šæ–­å®Œæˆï¼');
            resultContent.innerHTML = marked.parse(answer);
            resultArea.style.display = 'block';

        } catch (error) {
            log(`âŒ é”™è¯¯: ${error.message}`, true);
        } finally {
            setLoading(false);
        }
    });

    // --- åç«¯ä»£ç†è°ƒç”¨ (è‡ªåŠ¨ä½¿ç”¨ç›¸å¯¹è·¯å¾„) ---

    async function uploadFileToProxy(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        // è¿™é‡Œçš„è·¯å¾„å‰é¢åŠ äº† /ï¼Œä»£è¡¨ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ upload
        const res = await fetch(`${WORKER_URL}/upload`, {
            method: 'POST',
            body: formData
        });

        if (!res.ok) {
            // å°è¯•è¯»å–é”™è¯¯ä¿¡æ¯
            let errMsg = `Status ${res.status}`;
            try { errMsg = await res.text(); } catch(e){}
            throw new Error(`ä¸Šä¼ è¯·æ±‚å¤±è´¥: ${errMsg}`);
        }

        const data = await res.json();
        if (data.code !== 0) throw new Error(data.msg);
        return data.data.id;
    }

    async function processChatProxy(fileId) {
        // A. åˆ›å»ºå¯¹è¯
        const messageObject = [
            { type: "text", text: "è¯·ä»”ç»†æŸ¥çœ‹è¿™å¼ å›¾ç‰‡ï¼Œåˆ†æå® ç‰©å¯èƒ½çš„çš®è‚¤ç—…ç—‡çŠ¶ï¼Œå¹¶ç»™å‡ºæ²»ç–—å»ºè®®ã€‚" },
            { type: "image", file_id: fileId }
        ];

        const payload = {
            bot_id: COZE_BOT_ID,
            user_id: "user_" + Date.now(),
            stream: false,
            auto_save_history: true,
            additional_messages: [
                {
                    role: "user",
                    content_type: "object_string",
                    content: JSON.stringify(messageObject)
                }
            ]
        };

        const createRes = await fetch(`${WORKER_URL}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!createRes.ok) throw new Error(`åˆ›å»ºå¯¹è¯å¤±è´¥ Status: ${createRes.status}`);
        const createData = await createRes.json();
        
        if (createData.code !== 0) throw new Error(`åˆ›å»ºå¯¹è¯APIæŠ¥é”™: ${createData.msg}`);
        
        const conversationId = createData.data.conversation_id;
        const chatId = createData.data.id;

        // B. è½®è¯¢çŠ¶æ€
        let status = createData.data.status;
        let attempts = 0;
        
        while (status === 'in_progress' || status === 'created') {
            attempts++;
            if (attempts > 30) throw new Error("AI å“åº”è¶…æ—¶");
            
            log(`â³ AI æ€è€ƒä¸­... (${attempts}s)`);
            await new Promise(r => setTimeout(r, 1000));

            // è¯·æ±‚ç›¸å¯¹è·¯å¾„ /retrieve
            const checkRes = await fetch(`${WORKER_URL}/retrieve?chat_id=${chatId}&conversation_id=${conversationId}`, {
                method: 'GET'
            });
            const checkData = await checkRes.json();
            status = checkData.data.status;
            
            if (status === 'failed') throw new Error("AI å¤„ç†å¤±è´¥: " + checkData.data.last_error?.msg);
        }

        if (status !== 'completed') throw new Error(`ä»»åŠ¡å¼‚å¸¸çŠ¶æ€: ${status}`);

        // C. è·å–æœ€ç»ˆæ¶ˆæ¯ (è¯·æ±‚ç›¸å¯¹è·¯å¾„ /message/list)
        const listRes = await fetch(`${WORKER_URL}/message/list?chat_id=${chatId}&conversation_id=${conversationId}`, {
            method: 'GET'
        });
        
        const listData = await listRes.json();
        const messages = listData.data;
        
        const answerMsg = messages.find(m => m.role === 'assistant' && m.type === 'answer');
        if (answerMsg) return answerMsg.content;
        
        return "AI å¤„ç†å®Œæˆï¼Œä½†æœªè¿”å›æ–‡æœ¬å†…å®¹ã€‚";
    }

    function setLoading(isLoading) {
        diagnoseBtn.disabled = isLoading;
        spinner.style.display = isLoading ? 'block' : 'none';
        btnText.innerText = isLoading ? 'è¯Šæ–­ä¸­...' : 'å¼€å§‹è¯Šæ–­';
    }
</script>

</body>
</html>

