<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å® ç‰©çš®è‚¤ç—… AI å…è´¹åˆç­›</title>
    <!-- å¼•å…¥ Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #FF9EAA;
            --secondary-color: #FFF5E1;
            --text-color: #4A4A4A;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FAFAFA;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            color: #FF6B81;
            margin-bottom: 10px;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--primary-color);
            border-radius: 16px;
            background-color: var(--secondary-color);
            height: 200px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .upload-area:active { transform: scale(0.99); }

        .file-input-hidden {
            position: absolute; width: 100%; height: 100%;
            top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 20; 
        }

        .upload-content { text-align: center; pointer-events: none; }
        .upload-icon { font-size: 3rem; margin-bottom: 10px; }
        .upload-text { color: #888; font-size: 0.9rem; }

        #previewImage {
            width: 100%; height: 100%; object-fit: cover;
            display: none; position: absolute; top: 0; left: 0;
            border-radius: 14px; pointer-events: none;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-diagnose {
            background-color: var(--primary-color);
            color: white; border: none; padding: 16px;
            border-radius: 50px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(255, 158, 170, 0.4);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-diagnose:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

        #statusLog {
            font-size: 0.85rem; color: #666; background: #F2F3F5;
            padding: 12px; border-radius: 8px; display: none; white-space: pre-wrap;
        }

        #resultArea {
            background-color: #F8F9FA; border-radius: 12px;
            padding: 16px; display: none; line-height: 1.7;
        }
        #resultContent img { max-width: 100%; border-radius: 8px; }

        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #fff;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; margin-right: 10px; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ğŸ›’ è¯å“é“¾æ¥æ ·å¼ (æ ¸å¿ƒç¾åŒ–) --- */
        .drug-link {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            margin: 0 4px;
            background-color: #fff;
            color: #555;
            text-decoration: none;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #ddd;
            transition: all 0.2s;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .drug-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            color: #333;
        }

        /* ğŸ”¥ VIP æ¨å¹¿é“¾æ¥æ ·å¼ */
        .drug-link.promoted {
            background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            color: #FF4757;
            border-color: #FF9EAA;
            font-weight: bold;
            /* å‘¼å¸åŠ¨æ•ˆ */
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 129, 0.4); }
            70% { box-shadow: 0 0 0 4px rgba(255, 107, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 129, 0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ±ğŸ¶ å® ç‰©çš®è‚¤ç—…<br>AI å…è´¹åˆç­›</h1>

    <label class="upload-area" id="dropZone">
        <input type="file" id="fileInput" accept="image/*" class="file-input-hidden">
        <div class="upload-content" id="uploadPlaceholder">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ç‚¹å‡»è¿™é‡Œä¸Šä¼ ç…§ç‰‡</div>
        </div>
        <img id="previewImage" alt="Preview">
    </label>

    <button class="btn-diagnose" id="diagnoseBtn">
        <div class="loading-spinner" id="spinner"></div>
        <span id="btnText">å¼€å§‹è¯Šæ–­</span>
    </button>
    
    <div id="statusLog"></div>

    <div id="resultArea">
        <div id="resultContent"></div>
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    
    // 1. Cloudflare Pages è‡ªåŠ¨é€‚é…ï¼Œä¿æŒä¸ºç©ºå³å¯
    const WORKER_URL = ''; 

    // 2. å¡«å…¥ä½ çš„ Bot ID
    const COZE_BOT_ID = '7584683174408880138';          

    // ===========================================

    // --- ğŸ›’ æ ¸å¿ƒï¼šè‡ªå®šä¹‰å¸¦è´§é“¾æ¥é…ç½® ---
    // AI åªè¦æåˆ°è¿™äº›è¯ï¼Œå°±ä¼šç”Ÿæˆé«˜äº®æŒ‰é’®å¹¶è·³è½¬åˆ°ä½ æŒ‡å®šçš„é“¾æ¥
    const DRUG_MAP = {
        // "å…³é”®è¯": "ä½ çš„é“¾æ¥"
        "çš®ç‰¹èŠ¬": "https://s.click.taobao.com/t?e=m%3D2%26s%3D%2F3%2FwWSGQFfZw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2XUJ5qehhHKT0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JleziokvxOetQTZfHPHZ2OZt67s56ZoUzm0cdkhUSIdDrY3ktWAKfhx9%2FCLZz2VyWhvCAyzGN2MQb7ZpuXefhMU%2FgnGGKJ%2FhtV4sxbuQg7xPMmpJZ4UZC2wAF9OPNpcFr3zTxKM70AliNjwJcn7ARWQ6ocV0hb0k2TPv%2BG5KHOQOD12OJ4y1E5FgIPwuPoXhTvs068Yl7w3%2FA2kb&union_lens=lensId%3APUB%401766563097%4021500b88_2123_19b4f5dab3b_def9%40026N07t7NHyFTlF4aRYeJVNE%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_1_176656309747912520874%3Bscm%3A1007.30148.329090.pub_search-item_2ead5d68-0c6f-4fd7-ac44-0b5d5c98b190_", 
        "çº¢éœ‰ç´ ": "https://s.click.taobao.com/t?e=m%3D2%26s%3Dq1y4DtN68RJw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2BA17ISTnBpD0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JleziokvxOetQTZfHPHZ2OZt67uNvdEmtnfnqMMdMmP5rdjxsDBdoFgglO%2BfvzhpPMq2ed1bIvTScECDONo%2F1aEGuLK6lFG6EvefVY%2BDKwFLEd9Q5dUsQ8NYvbj%2B58h5pKGYu9cd3hRaMkj2H7jlVObKkkHGDF1NzTQoPw%3D%3D&union_lens=lensId%3APUB%401766563360%402106f1bb_207b_19b4f61ad86_cd0e%40027joFfg22GRu02bDU5xe8Ae%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_1_176656336020212520874%3Bscm%3A1007.30148.329090.pub_search-item_f1401f33-50a4-4ec2-8f31-36abb5079fc0_",
        "ä¼Šç»´èŒç´ ": "https://s.click.taobao.com/t?e=m%3D2%26s%3DCh0fLUbq1mdw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2lj9atNeFsQD0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JlezitDm2E92EA5UXKtg6HMQI2j%2Flm4TwNlZuowe6%2FtGg2%2FRjN4f8DSxNxufI3HrG2B3QYJH7pzSGZyugdRqHNK9s76FAori8myvPtIbY3La5LcVGYfsNGVxcQj%2BVCU%2BBWrWF3B6Jd9pUfrR1KilmKsn0wwkwRIkWNyzAAgoHQLvGc1txg5p7bh%2BFbQ%3D&union_lens=lensId%3APUB%401766563469%400b520354_20f1_19b4f6356d5_d985%40027Jh6gxyD2NiQ6JJD2SDWXQ%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_1_176656346908312520874%3Bscm%3A1007.30148.329090.pub_search-item_46dec217-58a1-4439-bfb7-b99c431e8f24_",
        "é…®åº·å”‘": "https://s.click.taobao.com/t?e=m%3D2%26s%3DRgwukv2qBHFw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2KWmsY8OsYSv0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JleziokvxOetQTZfHPHZ2OZt67s9B4xXEGTfTd6W29f8c%2F14Nia8wuSlpscP2ybq%2BpxvHebP8pONwZoSkkI8Oi6Mv4y%2BpviUTzGzwk%2FuprW1TdmBLeMqtJBmsqDZGL0GbiMMd4BiBMLr%2FJA1Qu9eQL6i%2FqFMdIp1rr4P3Q%3D%3D&union_lens=lensId%3APUB%401766563691%4021079449_20ae_19b4f66bd50_ce7a%40023VcIqTrPfUTz4L4eAkwZmx%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_5_176656369192712520874%3Bscm%3A1007.30148.329090.pub_search-item_a658cf5a-afa0-4e6f-8348-2089b9620efd_",
        "æ´—å¿…æ³°": "https://s.click.taobao.com/t?e=m%3D2%26s%3D7SDpRQUxlLNw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2CZuE6iUAClr0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JlezirKdtm8if3Ntw7wWdsmz%2BmE56ZoUzm0cdjFnKNBxtUOF56yhindHoRglfvBWgoHCL77hTosHl94klBd6XxAOwOkTgTUV%2FxKBAO%2BZvqVrf15pehjU9EIy4YJP7qa1tU3ZgS3jKrSQZrKg2Ri9Bm4jDHegZ4hAvgWL0W3IlblfqgO5TjFkWewKr1shhQs2DjqgEA%3D%3D&union_lens=lensId%3APUB%401766718218%40212be80d_2036_19b589ca0d6_2a3e%40023dl1O9XIaZ6SeY5IfWFHXr%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_5_176671821852512520874%3Bscm%3A1007.30148.329090.pub_search-item_700db901-8727-4943-8bd0-2c5fb34c33d0_",
        "è«åŒ¹ç½—æ˜Ÿè½¯è†": "https://s.click.taobao.com/t?e=m%3D2%26s%3DkFWlI7WfEKhw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2DeI845Q6AK30JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JlezipThS%2BZO0wJgujrvo6DYGdUwKBZXcUqb8XPxXj29W5twB5TpR8FihaLbpOcrrrp2Vigv%2BBvp3UipYpKF2z1B2dUv7nuknmw2P4%2BDKwFLEd9Q5dUsQ8NYvbgNcTS33sXfyZ1%2B8JHS%2FPwOIYULNg46oBA%3D&union_lens=lensId%3APUB%401766718576%400bb2a6a0_2eb3_19b58a2165f_a2bd%4002lE5h3mzZgQUWmKuyizlUM%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_5_176671857630112520874%3Bscm%3A1007.30148.329090.pub_search-item_e35bfb45-0921-48ef-b432-40cf59437fae_",
        "ä¼Šä¸½èç™½åœˆ": "https://s.click.taobao.com/t?e=m%3D2%26s%3DecK%2FBT8C5m5w4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq24bu283WD%2Bwj0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5Jlezir%2FpbmrmMAWLgZ7wnx2aMwA56ZoUzm0cdngJMd2yjs373q5%2F6sUdbJIxJnbkoVOSNVNJ32cn7xKvYp%2BTWH%2F7DL5rA851lUmCP7z9umFaE5BH2NCR5maCavCjO9AJYjY8CXJ%2BwEVkOqHFdIW9JNkz7%2FhuShzkDg9djhoLANLo%2B%2Bcfy3qngGkAUt3GJe8N%2FwNpGw%3D%3D&union_lens=lensId%3APUB%401766718739%40212b047c_2103_19b58a4929a_3f92%4002T17iNMKFud96RGVXNkK0R%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_9_176671873918012520874%3Bscm%3A1007.30148.329090.pub_search-item_68080f4b-1480-415d-b588-90e9a43cd895_",
        "å¤åˆç»´ç”Ÿç´ B": "https://s.click.taobao.com/t?e=m%3D2%26s%3D8d7GRREq%2BXFw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFuhCZFSw9yq2K2aOxsrFxlH0JlhLk0Jl4fmB7E%2BalZfSrAsMK%2BddScro%2Fi1T%2FGEHGtD5eST1FcWQhXCEiyvUOUCBv1l5JlezitDm2E92EA5Ug93%2F81dRO%2FzM%2FBg8zcUNk4we6%2FtGg2%2FRjN4f8DSxNxspUgV93Fzo10ZCT4%2BePGGcCgFM8EAr609DK70C%2Bmhvg%2B1li2KikAmuKZ%2B8s%2BWoGEFauZ4X%2F%2FsSio%2BDKwFLEd9Q5dUsQ8NYvbjmQHRZ9JOOxnyyAcB%2BI%2FnxIYULNg46oBA%3D&union_lens=lensId%3APUB%401766718931%40213e4221_20b7_19b58a78177_5994%40023LjIbs0nQbXblqDI7TzAxw%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3BtkScm%3AselectionPlaza_site_4358_0_0_0_4_176671893140512520874%3Bscm%3A1007.30148.329090.pub_search-item_dc61129b-b31e-43b1-8c0a-c39d8880fccb_",

// ä½ å¯ä»¥ç»§ç»­æ·»åŠ ...
    };

    // é»˜è®¤å…œåº•æœç´¢é“¾æ¥ (AI æåˆ°çš„è¯å¦‚æœä¸åœ¨ä¸Šé¢ï¼Œå°±å»è¿™é‡Œæœ)
    const DEFAULT_SEARCH_URL = "https://s.taobao.com/search?q=";

    // ===========================================

    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const diagnoseBtn = document.getElementById('diagnoseBtn');
    const resultArea = document.getElementById('resultArea');
    const resultContent = document.getElementById('resultContent');
    const statusLog = document.getElementById('statusLog');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btnText');

    let selectedFile = null;

    function log(msg, isError = false) {
        statusLog.style.display = 'block';
        statusLog.innerText = msg;
        statusLog.style.color = isError ? '#FF4D4F' : '#666';
        if(isError) console.error(msg); else console.log(msg);
    }

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            if (!file.type.startsWith('image/')) return alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (evt) => {
                previewImage.src = evt.target.result;
                previewImage.style.display = 'block';
                log(`ğŸ“¸ å·²é€‰å›¾ç‰‡: ${file.name}`);
            };
            reader.readAsDataURL(file);
        }
    });

    diagnoseBtn.addEventListener('click', async () => {
        if (window.location.protocol === 'file:') return alert('âŒ è¯·éƒ¨ç½²åˆ° Cloudflare Pages åå†è¿è¡Œï¼');
        if (!selectedFile) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
        
        setLoading(true);
        resultArea.style.display = 'none';
        
        try {
            log('ğŸš€ 1/3 æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');
            const fileId = await uploadFileToProxy(selectedFile);
            
            log('ğŸ¤– 2/3 å›¾ç‰‡å·²æ¥æ”¶ï¼ŒAIæ­£åœ¨æ€è€ƒä¸­...');
            const answer = await processChatProxy(fileId);
            
            log('âœ¨ 3/3 è¯Šæ–­å®Œæˆï¼');
            
            // --- æ™ºèƒ½é“¾æ¥æ›¿æ¢é€»è¾‘ ---
            const formattedAnswer = answer.replace(/\[\[(.*?)\]\]/g, (match, rawName) => {
                const drugName = rawName.trim();
                let targetUrl = '';
                let isPromoted = false;

                // æ¨¡ç³ŠåŒ¹é…é…ç½®è¡¨
                for (const [key, url] of Object.entries(DRUG_MAP)) {
                    if (drugName.includes(key) || key.includes(drugName)) {
                        targetUrl = url;
                        isPromoted = true;
                        break;
                    }
                }

                // å…œåº•é€»è¾‘
                if (!targetUrl) {
                    targetUrl = DEFAULT_SEARCH_URL + encodeURIComponent(drugName);
                }

                const icon = isPromoted ? 'ğŸ”¥' : 'ğŸ›’';
                const label = isPromoted ? `æ¨è ${drugName}` : `æœ ${drugName}`;
                
                // è¿”å›è‡ªå®šä¹‰æ ·å¼çš„ A æ ‡ç­¾
                return `<a href="${targetUrl}" target="_blank" class="drug-link ${isPromoted ? 'promoted' : ''}">${icon} ${label}</a>`;
            });

            resultContent.innerHTML = marked.parse(formattedAnswer);
            resultArea.style.display = 'block';
            // æ»šåŠ¨åˆ°ç»“æœ
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (error) {
            log(`âŒ é”™è¯¯: ${error.message}`, true);
        } finally {
            setLoading(false);
        }
    });

    // --- API è°ƒç”¨é€»è¾‘ ---
    async function uploadFileToProxy(file) {
        const formData = new FormData();
        formData.append('file', file);
        const res = await fetch(`${WORKER_URL}/upload`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`ä¸Šä¼ å¤±è´¥: ${res.status}`);
        const data = await res.json();
        if (data.code !== 0) throw new Error(data.msg);
        return data.data.id;
    }

    async function processChatProxy(fileId) {
        // ä¿®æ”¹ Promptï¼Œè¦æ±‚ AI ä½¿ç”¨ [[ ]] åŒ…è£¹è¯å
        const messageObject = [
            { 
                type: "text", 
                text: "è¯·ä»”ç»†åˆ†æå›¾ç‰‡ä¸­çš„å® ç‰©çš®è‚¤ç—…ç—‡çŠ¶ã€‚å…³é”®è¦æ±‚ï¼šå»ºè®®ç”¨è¯æ—¶ï¼Œå¿…é¡»ç”¨åŒä¸­æ‹¬å·åŒ…è£¹è¯å“åç§°ï¼Œä¾‹å¦‚ [[çš®ç‰¹èŠ¬]]ã€[[ä¼Šç»´èŒç´ ]]ï¼Œä»¥ä¾¿ç”Ÿæˆè´­ä¹°é“¾æ¥ã€‚" 
            },
            { type: "image", file_id: fileId }
        ];

        const payload = {
            bot_id: COZE_BOT_ID,
            user_id: "user_" + Date.now(),
            stream: false,
            auto_save_history: true,
            additional_messages: [
                { role: "user", content_type: "object_string", content: JSON.stringify(messageObject) }
            ]
        };

        const createRes = await fetch(`${WORKER_URL}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const createData = await createRes.json();
        if (createData.code !== 0) throw new Error(`å¯¹è¯åˆ›å»ºå¤±è´¥: ${createData.msg}`);
        
        const conversationId = createData.data.conversation_id;
        const chatId = createData.data.id;

        // è½®è¯¢
        let status = createData.data.status;
        let attempts = 0;
        while (status === 'in_progress' || status === 'created') {
            attempts++;
            if (attempts > 40) throw new Error("AI å“åº”è¶…æ—¶");
            log(`â³ AI æ€è€ƒä¸­... (${attempts}s)`);
            await new Promise(r => setTimeout(r, 1000));
            
            const checkRes = await fetch(`${WORKER_URL}/retrieve?chat_id=${chatId}&conversation_id=${conversationId}`);
            const checkData = await checkRes.json();
            status = checkData.data.status;
            if (status === 'failed') throw new Error("AI å¤„ç†å¤±è´¥");
        }

        const listRes = await fetch(`${WORKER_URL}/message/list?chat_id=${chatId}&conversation_id=${conversationId}`);
        const listData = await listRes.json();
        const answerMsg = listData.data.find(m => m.role === 'assistant' && m.type === 'answer');
        
        return answerMsg ? answerMsg.content : "AI æœªè¿”å›å†…å®¹";
    }

    function setLoading(isLoading) {
        diagnoseBtn.disabled = isLoading;
        spinner.style.display = isLoading ? 'block' : 'none';
        btnText.innerText = isLoading ? 'è¯Šæ–­ä¸­...' : 'å¼€å§‹è¯Šæ–­';
    }
</script>

</body>
</html>
